{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agentic RAG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  {% csrf_token %}
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#4f46e5; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 16px; padding: 20px; }
    .row { display:flex; gap:12px; align-items:center; }
    .col { display:flex; flex-direction:column; gap:8px; }
    .btn { background: var(--accent); color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .input, textarea { width:100%; background:#0b1220; border:1px solid #1f2937; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; }
    textarea { min-height:80px; resize:vertical; }
    .muted { color: var(--muted); font-size: 0.9rem; }
    .pill { padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; color:#c7d2fe; font-size:.8rem; }
    .messages { display:flex; flex-direction:column; gap:12px; max-height: 52vh; overflow:auto; padding-right:6px; }
    .msg { padding:12px 14px; border-radius:14px; line-height:1.5; border:1px solid #1f2937; }
    .msg.user { background:#111827; align-self:flex-end; }
    .msg.bot { background:#0b1220; }
    .divider { height:1px; background:#1f2937; margin:16px 0; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>üß† Agentic RAG Console</h2>
      <span class="pill">Django</span>
    </div>

    <!-- Upload Documents -->
    <div class="card" style="margin-bottom:18px;">
      <h3 style="margin:0 0 8px 0;">üìÇ Ingest Documents</h3>
      <p class="muted" style="margin:0 0 12px 0;">Upload PDFs, text, or markdown. They‚Äôll be embedded into your vector store.</p>
      <form id="upload-form" class="row" enctype="multipart/form-data">
        <input class="input" type="file" id="files" name="files" multiple accept=".pdf,.txt,.md,.csv,.docx" />
        <button class="btn" id="upload-btn" type="submit">Upload</button>
      </form>
      <div id="upload-status" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- Chat / Ask -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;">üí¨ Ask your knowledge base</h3>
      <div class="messages" id="messages"></div>
      <div class="divider"></div>
      <div class="col">
        <textarea id="question" placeholder="Ask anything about your uploaded docs..."></textarea>
        <div class="row">
          <input class="input" id="metadata" placeholder='Optional: metadata filters as JSON, e.g. {"source":"policy.pdf"}' />
          <button class="btn" id="ask-btn">Ask</button>
        </div>
        <span class="muted">Tip: try ‚ÄúSummarize all docs in 5 bullets with citations.‚Äù</span>
      </div>
    </div>
  </div>

  <script>
    // CSRF helper (Django)
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // DOM elements
    const uploadForm = document.getElementById('upload-form');
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');
    const askBtn = document.getElementById('ask-btn');
    const messages = document.getElementById('messages');
    const questionEl = document.getElementById('question');
    const metadataEl = document.getElementById('metadata');

    function addMessage(text, role = 'bot') {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    // Upload handler
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const filesInput = document.getElementById('files');
      if (!filesInput.files.length) {
        uploadStatus.textContent = 'Please choose at least one file.';
        return;
      }
      uploadBtn.disabled = true;
      uploadStatus.textContent = 'Uploading & indexing‚Ä¶';

      const formData = new FormData();
      for (const f of filesInput.files) formData.append('files', f);

      try {
        const res = await fetch('/upload/', {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          body: formData
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Upload failed');
        uploadStatus.textContent = `Indexed ${data.indexed_count || 0} file(s).`;
      } catch (err) {
        uploadStatus.textContent = `Error: ${err.message}`;
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // Ask handler
    askBtn.addEventListener('click', async () => {
      const q = questionEl.value.trim();
      if (!q) return;
      addMessage(q, 'user');
      questionEl.value = '';
      askBtn.disabled = true;

      let filters = null;
      if (metadataEl.value.trim()) {
        try { filters = JSON.parse(metadataEl.value.trim()); }
        catch { addMessage('‚ö†Ô∏è Invalid JSON in metadata filters. Ignoring.', 'bot'); }
      }

      try {
        const res = await fetch('/ask/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ question: q, filters })
        });

        // If your /ask/ streams text/plain, adapt here with ReadableStream
        if (res.headers.get('Content-Type')?.includes('application/json')) {
          const data = await res.json();
          addMessage(data.answer || 'No answer returned.', 'bot');
          if (data.citations?.length) {
            addMessage('Sources: ' + data.citations.map(c => c.title || c.id).join(', '), 'bot');
          }
        } else {
          const text = await res.text();
          addMessage(text || 'No answer returned.', 'bot');
        }
      } catch (err) {
        addMessage('Error: ' + err.message, 'bot');
      } finally {
        askBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
